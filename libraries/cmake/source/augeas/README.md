# Linux

## x86_64

```bash
cat /etc/issue
CentOS release 6.10 (Final)
Kernel \r on an \m
```

```bash
ldd --version
ldd (GNU libc) 2.12.2
```

```bash
yum info glibc

...

Version     : 2.12
Release     : 1.212.el6

...

```

## AArch64

```bash
cat /etc/issue
Ubuntu 16.04.7 LTS \n \l
```

```bash
ldd --version
ldd (Ubuntu GLIBC 2.23-0ubuntu11.2) 2.23
```

```bash
apt show libc-bin
Package: libc-bin
Version: 2.23-0ubuntu11.3
...

```

## Common

Prepare the environment

```bash
export PATH="/opt/osquery-toolchain/usr/bin:${PATH}"
export CFLAGS="--sysroot /opt/osquery-toolchain"
export CXXFLAGS="${CFLAGS}"
export CPPFLAGS="${CFLAGS}"
export LDFLAGS="${CFLAGS}"
export CC=clang
```

Fix the `FATAL: kernel too old` issue in the toolchain:

```bash
ln \
  -sf \
  /opt/osquery-toolchain/usr/bin/llvm-ar \
  /opt/osquery-toolchain/usr/bin/ar

ln \
  -sf \
  /opt/osquery-toolchain/usr/bin/llvm-ranlib \
  /opt/osquery-toolchain/usr/bin/ranlib
```

Disables tests, documentation and examples:

```
sed -i '/SUBDIRS += tests man doc examples/d' Makefile.am
sed -i '/SUBDIRS += gnulib\/tests/d' Makefile.am
```

Disable the command line tools:

```
sed -i '/AUGEAS_CHECK_READLINE/d' configure.ac
sed -i '/bin_PROGRAMS = augtool augparse augmatch/c\bin_PROGRAMS = ' src/Makefile.am
```

Pass the include headers of the libxml2 library we have in osquery (make sure to set the correct architecture!). Also set a fake library to pass the configuration step.

```
export LIBXML_CFLAGS="-I/home/ubuntu/osquery/libraries/cmake/source/libxml2/src/include -I/home/ubuntu/osquery/libraries/cmake/source/libxml2/generated/config/linux/x86_64 -I/home/ubuntu/osquery/libraries/cmake/source/libxml2/generated/version/linux/x86_64"
export LIBXML_LIBS="-lpthreads"
```

Now configure the library

```
./autogen.sh \
  --enable-static \
  --enable-shared=no \
  --without-selinux
```
 
Build the library

```
make -j $(nproc)
```

Copy the generated augeas files:

 - `config.h`
 - `datadir.h`
 - `parser.c`
 - `parser.h`
 - `lexer.c`

Copy the generated gnulib files:

 - `config.h` (use the augeas one)
 - All the files containing `AUTOGENERATED` under `lib`

# macOS

## x86_64

```bash
export CFLAGS="-isysroot /Applications/Xcode_13.0.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.3.sdk -mmacosx-version-min=10.12 -Wunguarded-availability-new"
export LDFLAGS="${CFLAGS}"
export CC=clang
```

Disables tests, documentation and examples:

```
gsed -i '/SUBDIRS += tests man doc examples/d' Makefile.am
gsed -i '/SUBDIRS += gnulib\/tests/d' Makefile.am
```

Disable the command line tools:

```
gsed -i '/AUGEAS_CHECK_READLINE/d' configure.ac
gsed -i '/bin_PROGRAMS = augtool augparse augmatch/c\bin_PROGRAMS = ' src/Makefile.am
```

Make sure we disable `open_memstream`, since it's only available in 10.12 and later

```
gsed -i 's/open_memstream//g' configure.ac
```

Pass the include headers of the libxml2 library we have in osquery (make sure to set the correct architecture!). Also set a fake library to pass the configuration step.

```
export LIBXML_CFLAGS="-I/Users/alessandro/Projects/osquery/libraries/cmake/source/libxml2/src/include -I/Users/alessandro/Projects/osquery/libraries/cmake/source/libxml2/generated/config/linux/x86_64 -I/Users/alessandro/Projects/osquery/libraries/cmake/source/libxml2/generated/version/linux/x86_64"
export LIBXML_LIBS="-lpthreads"
```

Now configure the library

```
./autogen.sh \
  --enable-static \
  --enable-shared=no \
  --without-selinux
```
 
Build the library

```
make -j $(nproc)
```

Copy the generated augeas files:

 - `config.h`
 - `datadir.h`
 - `parser.c`
 - `parser.h`
 - `lexer.c`

Copy the generated gnulib files:

 - `config.h` (use the augeas one)
 - All the files containing `AUTOGENERATED` under `lib`

## m1

Same as above, but use the following environment variables instead:

```bash
export CFLAGS="-isysroot /Applications/Xcode_13.0.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.3.sdk -mmacosx-version-min=10.15 -Wunguarded-availability-new -target arm64-apple-macos10.15"
export LDFLAGS="${CFLAGS}"
export CC=clang
```

Also pass this additional flag to `autogen.sh`: `--host=arm64-apple-macos10.15`